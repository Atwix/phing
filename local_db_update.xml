<?xml version="1.0" ?>
<project name="atwix local db update" basedir="." default="build">
<property name="version" value="1.0" />
<property file="build.properties" />
<property name="privkeyfile" value="/home/jenkins/.ssh/id_rsa" /> 
<property name="pubkeyfile" value="/home/jenkins/.ssh/id_rsa.pub" /> 
<property name="remote.n98.path" value="${sync.destination.projectdir}/var/n98" />
<property name="dump.parameters" value="@sales @customers @stripped" />
<property name="dump.filename" value="dev_dump.sql" />

<target name="remote-dump">
  <echo message="Connecting ${sync.remote.user}@${sync.remote.host}" />
  <ssh username="${sync.remote.user}" 
  host="${sync.remote.host}" 
  pubkeyfile="${pubkeyfile}"
  privkeyfile="${privkeyfile}"
  display="false"
  command="cd ${sync.destination.projectdir}/var/n98 2>&amp;1" 
  property="cd.output" />
  <if>
    <contains string="${cd.output}" substring="No such file" />
    <then>
      <phingcall target="-upload-n98" />
    </then>
  </if>
  <phingcall target="-execute-n98" />
  <phingcall target="-gzip-dump" />
  <phingcall target="-download-dump" />
  <phingcall target="-remove-dump" />
</target>

<target name="-upload-n98">
  <echo message="Uploading n98-magerun.phar to the server" />
  <scp username="${sync.remote.user}"
  host="${sync.remote.host}"
  pubkeyfile="${pubkeyfile}"
  privkeyfile="${privkeyfile}"
  todir="${remote.n98.path}"
  file="../../system/n98/n98-magerun.phar" />
</target>

<target name="-execute-n98">
  <echo message="Executing n98-magerun.phar database dump with parameters: ${dump.parameters}" />
  <ssh username="${sync.remote.user}" 
  host="${sync.remote.host}" 
  pubkeyfile="${pubkeyfile}"
  privkeyfile="${privkeyfile}"
  display="false"
  command="cd ${sync.destination.projectdir}/var/n98/ ; rm -f *.sql ; ./n98-magerun.phar db:dump -f --strip='${dump.parameters}' ${dump.filename} 2>&amp;1" 
  property="n98.output" />
  <echo message="${n98.output}" />
</target>

<target name="-gzip-dump" >
  <echo message="Gzipping current dump" />
  <ssh username="${sync.remote.user}" 
  host="${sync.remote.host}" 
  pubkeyfile="${pubkeyfile}"
  privkeyfile="${privkeyfile}"
  display="false"
  command="cd ${sync.destination.projectdir}/var/n98/ ; gzip -9 -f ${dump.filename} 2>&amp;1" 
  property="n98.output" />
</target>

<target name="-download-dump">
  <echo message="Downloading dump to the local server" />
  <exec command="mkdir dumps" dir="." />
  <scp username="${sync.remote.user}"
  host="${sync.remote.host}"
  pubkeyfile="${pubkeyfile}"
  privkeyfile="${privkeyfile}"
  fetch="true"
  todir="dumps"
  file="${remote.n98.path}/${dump.filename}.gz">
  </scp>
</target>

<target name="-remove-dump">
  <ssh username="${sync.remote.user}" 
  host="${sync.remote.host}" 
  pubkeyfile="${pubkeyfile}"
  privkeyfile="${privkeyfile}"
  display="false"
  command="cd ${remote.n98.path} ; rm -f ${dump.filename}.gz ; rm -f ${dump.filename} 2>&amp;1" 
  property="remove.output" />
  <echo message="${remove.output}" />
</target>
</project>
